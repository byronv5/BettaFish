<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çˆ¬è™«é…ç½®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", Arial, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            padding: 16px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: #fff;
            border-radius: 4px;
            padding: 16px 24px;
            margin-bottom: 16px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
            border: 1px solid #e8ecf0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #303133;
            font-size: 18px;
            font-weight: 600;
        }

        .back-btn {
            background: #fff;
            color: #606266;
            padding: 7px 16px;
            border-radius: 4px;
            border: 1px solid #d9dfe6;
            text-decoration: none;
            font-size: 13px;
            transition: all 0.2s;
        }

        .back-btn:hover {
            border-color: #2d5f8a;
            color: #2d5f8a;
            transform: none;
        }

        .config-card {
            background: #fff;
            border-radius: 4px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
            border: 1px solid #e8ecf0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #303133;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-group .hint {
            color: #909399;
            font-size: 12px;
            margin-top: 4px;
        }

        /* å…³é”®è¯æ ‡ç­¾ */
        .keywords-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
            max-height: none;
            overflow: hidden;
            transition: max-height 0.3s ease;
            position: relative;
        }

        .keywords-container.collapsed {
            max-height: 120px;
        }


        .toggle-keywords-btn {
            background: none;
            border: none;
            color: #2d5f8a;
            font-size: 13px;
            cursor: pointer;
            padding: 4px 0;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: color 0.2s;
        }

        .toggle-keywords-btn:hover {
            color: #1d4a6e;
            text-decoration: underline;
        }

        .keyword-tag {
            background: #f5f7fa;
            color: #606266;
            padding: 5px 12px;
            border-radius: 3px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e8ecf0;
        }

        .keyword-tag:hover {
            background: #e8f0f7;
            border-color: #b8d4ec;
        }

        .keyword-tag.selected {
            background: #2d5f8a;
            color: #fff;
            border-color: #2d5f8a;
        }

        .keyword-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9dfe6;
            border-radius: 4px;
            font-size: 13px;
            transition: border-color 0.2s;
        }

        .keyword-input:focus {
            outline: none;
            border-color: #2d5f8a;
            box-shadow: 0 0 0 2px rgba(45,95,138,0.1);
        }

        /* å¹³å°é€‰æ‹© */
        .platforms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 12px;
        }

        .platform-item {
            background: #f5f7fa;
            border: 1px solid #e8ecf0;
            border-radius: 4px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .platform-item:hover {
            background: #e8f0f7;
            border-color: #b8d4ec;
        }

        .platform-item.selected {
            background: #e8f0f7;
            color: #2d5f8a;
            border-color: #2d5f8a;
        }

        .platform-icon {
            font-size: 28px;
            margin-bottom: 4px;
        }

        .platform-name {
            font-size: 13px;
            font-weight: 500;
        }

        /* ä¸‹æ‹‰æ¡† */
        select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9dfe6;
            border-radius: 4px;
            font-size: 13px;
            background: #fff;
            transition: border-color 0.2s;
        }

        select:focus {
            outline: none;
            border-color: #2d5f8a;
        }

        /* æŒ‰é’® */
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #2d5f8a;
            color: #fff;
        }

        .btn-primary:hover {
            background: #1d4a6e;
            transform: none;
        }

        .btn-secondary {
            background: #fff;
            color: #606266;
            border: 1px solid #d9dfe6;
        }

        .btn-secondary:hover {
            border-color: #2d5f8a;
            color: #2d5f8a;
        }

        /* é…ç½®åˆ—è¡¨ */
        .config-list {
            margin-top: 16px;
        }

        .config-item {
            background: #f5f7fa;
            border-radius: 4px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 3px solid #2d5f8a;
            border-top: 1px solid #e8ecf0;
            border-right: 1px solid #e8ecf0;
            border-bottom: 1px solid #e8ecf0;
        }

        .config-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .config-item-title {
            font-size: 14px;
            font-weight: 600;
            color: #303133;
        }

        .config-item.paused {
            border-left-color: #d9dfe6;
            opacity: 0.75;
        }

        .status-paused {
            background: #f5f5f5;
            color: #909399;
            border: 1px solid #d9dfe6;
        }

        .item-actions {
            display: flex;
            gap: 6px;
        }

        .pause-btn {
            background: #fff;
            color: #d48806;
            border: 1px solid #ffe58f;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .pause-btn:hover {
            background: #fffbe6;
        }

        .pause-btn.resume {
            color: #389e0d;
            border-color: #b7eb8f;
        }

        .pause-btn.resume:hover {
            background: #f6ffed;
        }

        .pause-btn:disabled {
            color: #c0c4cc;
            border-color: #e8ecf0;
            background: #f5f7fa;
            cursor: not-allowed;
        }

        .delete-btn {
            background: #fff;
            color: #ff4d4f;
            border: 1px solid #ffccc7;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .delete-btn:hover {
            background: #ff4d4f;
            color: #fff;
            border-color: #ff4d4f;
        }

        .config-item-details {
            color: #909399;
            font-size: 13px;
            line-height: 1.6;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 8px;
        }

        .status-running {
            background: #e6f7ff;
            color: #1890ff;
            border: 1px solid #91d5ff;
        }

        .status-completed {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }

        .status-failed {
            background: #fff2f0;
            color: #ff4d4f;
            border: 1px solid #ffccc7;
        }

        .status-pending {
            background: #fff7e6;
            color: #d48806;
            border: 1px solid #ffe58f;
        }

        /* Cookieé…ç½® */
        .cookie-section {
            margin-top: 8px;
        }

        .cookie-platform-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .cookie-tab {
            padding: 5px 12px;
            border: 1px solid #d9dfe6;
            border-radius: 4px;
            background: #f5f7fa;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .cookie-tab:hover {
            background: #e8f0f7;
            border-color: #b8d4ec;
        }

        .cookie-tab.active {
            background: #2d5f8a;
            color: #fff;
            border-color: #2d5f8a;
        }

        .cookie-tab .cookie-status {
            display: inline-block;
            width: 7px;
            height: 7px;
            border-radius: 50%;
            margin-left: 4px;
        }

        .cookie-status.configured {
            background: #52c41a;
        }

        .cookie-status.empty {
            background: #ff4d4f;
        }

        .cookie-textarea {
            width: 100%;
            min-height: 70px;
            padding: 8px 10px;
            border: 1px solid #d9dfe6;
            border-radius: 4px;
            font-size: 12px;
            font-family: "SF Mono", "Consolas", monospace;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .cookie-textarea:focus {
            outline: none;
            border-color: #2d5f8a;
            box-shadow: 0 0 0 2px rgba(45,95,138,0.1);
        }

        .cookie-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            align-items: center;
        }

        .btn-small {
            padding: 5px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-save-cookie {
            background: #2d5f8a;
            color: #fff;
        }

        .btn-save-cookie:hover {
            background: #1d4a6e;
        }

        .cookie-save-status {
            font-size: 12px;
            color: #909399;
        }

        .keyword-date-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .keyword-date-bar label {
            font-size: 13px;
            color: #606266;
            font-weight: normal;
            margin-bottom: 0;
            white-space: nowrap;
        }

        .keyword-date-bar input[type="date"] {
            padding: 5px 10px;
            border: 1px solid #d9dfe6;
            border-radius: 4px;
            font-size: 13px;
            color: #303133;
            background: #fff;
            outline: none;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .keyword-date-bar input[type="date"]:focus {
            border-color: #2d5f8a;
        }

        .keyword-date-bar .kw-count {
            font-size: 12px;
            color: #909399;
        }

        .loading {
            text-align: center;
            padding: 16px;
            color: #909399;
            font-size: 13px;
        }

        .message {
            padding: 10px 16px;
            border-radius: 4px;
            margin-bottom: 16px;
            font-size: 13px;
        }

        .message-success {
            background: #f6ffed;
            color: #389e0d;
            border: 1px solid #b7eb8f;
        }

        .message-error {
            background: #fff2f0;
            color: #cf1322;
            border: 1px solid #ffccc7;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="header">
            <h1>ğŸ•·ï¸ çˆ¬è™«é…ç½®</h1>
            <a href="/monitoring/" class="back-btn">â† è¿”å›ä»ªè¡¨æ¿</a>
        </div>

        <!-- é…ç½®è¡¨å• -->
        <div class="config-card">
            <h2 style="margin-bottom: 25px; color: #2d3748;">æ–°å»ºçˆ¬è™«ä»»åŠ¡</h2>

            <!-- 1. å…³é”®è¯é…ç½® -->
            <div class="form-group">
                <label>
                    ğŸ“ å…³é”®è¯é…ç½®
                    <span style="color: #e53e3e;">*</span>
                </label>
                <!-- æ—¥æœŸç­›é€‰ï¼šæ§åˆ¶ä¸‹æ–¹å…³é”®è¯æ ‡ç­¾çš„æ¥æºæ—¥æœŸ -->
                <div class="keyword-date-bar">
                    <label for="keywordDateInput">å…³é”®è¯æ—¥æœŸ:</label>
                    <input type="date" id="keywordDateInput" onchange="onKeywordDateChange()" />
                    <span id="kwCountLabel" class="kw-count"></span>
                </div>
                <div id="keywordTags" class="keywords-container collapsed"></div>
                <button id="toggleKeywordsBtn" class="toggle-keywords-btn" onclick="toggleKeywords()">
                    <span id="toggleKeywordsIcon">â–¼</span>
                    <span id="toggleKeywordsText">å±•å¼€æ›´å¤š</span>
                </button>
                <input
                    type="text"
                    id="manualKeywords"
                    class="keyword-input"
                    placeholder="æ‰‹åŠ¨è¾“å…¥å…³é”®è¯ï¼ˆç”¨é€—å·æˆ–ç©ºæ ¼åˆ†éš”ï¼Œæœ€å¤š10ä¸ªï¼‰"
                />
                <div class="hint">ğŸ’¡ é€‰æ‹©æ—¥æœŸå¯æŸ¥çœ‹å¯¹åº”æ—¥æœŸçš„çƒ­ç‚¹å…³é”®è¯æ ‡ç­¾ï¼Œä¹Ÿå¯æ‰‹åŠ¨è¾“å…¥è‡ªå®šä¹‰å…³é”®è¯</div>
            </div>

            <!-- 2. å¹³å°é€‰æ‹© -->
            <div class="form-group">
                <label>
                    ğŸŒ æŠ“å–å¹³å°
                    <span style="color: #e53e3e;">*</span>
                </label>
                <div id="platformsGrid" class="platforms-grid"></div>
                <div class="hint">ğŸ’¡ å¯ä»¥åŒæ—¶é€‰æ‹©å¤šä¸ªå¹³å°è¿›è¡Œçˆ¬å–</div>
            </div>

            <!-- 3. Cookieé…ç½® -->
            <div class="form-group">
                <label>ğŸª å¹³å°Cookieé…ç½®</label>
                <div class="cookie-section">
                    <div id="cookiePlatformTabs" class="cookie-platform-tabs"></div>
                    <textarea id="cookieInput" class="cookie-textarea"
                        placeholder="ä»æµè§ˆå™¨å¼€å‘è€…å·¥å…·(F12)ä¸­å¤åˆ¶Cookieå­—ç¬¦ä¸²ç²˜è´´åˆ°æ­¤å¤„&#10;æ ¼å¼: name1=value1; name2=value2; ..."></textarea>
                    <div class="cookie-actions">
                        <button class="btn-small btn-save-cookie" onclick="saveCookie()">ä¿å­˜Cookie</button>
                        <span id="cookieSaveStatus" class="cookie-save-status"></span>
                    </div>
                </div>
                <div class="hint">ğŸ’¡ åœ¨Windowsæµè§ˆå™¨ç™»å½•å„å¹³å°åï¼ŒF12æ‰“å¼€å¼€å‘è€…å·¥å…· â†’ Network â†’ ç‚¹å‡»ä»»æ„è¯·æ±‚ â†’ å¤åˆ¶Cookieè¯·æ±‚å¤´çš„å€¼ã€‚é¦–æ¬¡é…ç½®åä¼šè‡ªåŠ¨ä¿å­˜ç™»å½•çŠ¶æ€</div>
            </div>

            <!-- 4. æ‰§è¡Œè®¡åˆ’ -->
            <div class="form-group">
                <label>
                    â° æ‰§è¡Œè®¡åˆ’
                    <span style="color: #e53e3e;">*</span>
                </label>
                <select id="intervalSelect">
                    <option value="5min">æ¯éš” 5 åˆ†é’Ÿ</option>
                    <option value="10min">æ¯éš” 10 åˆ†é’Ÿ</option>
                    <option value="30min">æ¯éš” 30 åˆ†é’Ÿ</option>
                    <option value="1h" selected>æ¯éš” 1 å°æ—¶</option>
                </select>
                <div class="hint">ğŸ’¡ ç³»ç»Ÿä¼šæŒ‰ç…§è®¾å®šçš„æ—¶é—´é—´éš”è‡ªåŠ¨æ‰§è¡Œçˆ¬è™«ä»»åŠ¡</div>
            </div>

            <!-- æŒ‰é’® -->
            <div class="btn-group">
                <button id="startBtn" class="btn btn-primary" onclick="saveConfig()">
                    â–¶ å¯åŠ¨çˆ¬è™«ï¼ˆAIæ¨¡æ‹Ÿï¼‰
                </button>
            </div>
            <div id="message" style="display: block; margin-top: 12px; color: #909399; font-size: 12px;">
                â„¹ï¸ çˆ¬è™«åŠŸèƒ½ä»…åšæ¼”ç¤ºä¸åšçœŸå®æ•°æ®çˆ¬å–ï¼Œæ•°æ®ç”±AIæ¨¡æ‹Ÿç”Ÿæˆï¼Œè¯·ä½¿ç”¨å®˜æ–¹å¼€æ”¾ APIï¼ˆå¾®åšã€çŸ¥ä¹ç­‰å‡æœ‰å¼€å‘è€… APIï¼‰è·å–æ•°æ®ã€‚
            </div>
        </div>

        <!-- å½“å‰é…ç½®åˆ—è¡¨ -->
        <div class="config-card">
            <h2 style="margin-bottom: 20px; color: #2d3748;">
                å½“å‰é…ç½®
                <span id="jobCount" class="status-badge status-running">0 ä¸ªä»»åŠ¡</span>
            </h2>
            <div id="configList" class="config-list">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <script>
        let availableKeywords = [];
        let selectedKeywords = [];
        let availablePlatforms = [];
        let selectedPlatforms = [];

        let cookieStatus = {};
        let activeCookiePlatform = '';

        let configRefreshTimer = null;

        // è¿”å›ä»Šå¤©çš„ CST æ—¥æœŸå­—ç¬¦ä¸² YYYY-MM-DD
        function getTodayCST() {
            const now = new Date();
            const cst = new Date(now.getTime() + (8 * 60 - now.getTimezoneOffset()) * 60000);
            return cst.toISOString().slice(0, 10);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('keywordDateInput').value = new Date().toISOString().slice(0, 10);
            loadAvailableKeywords();
            loadAvailablePlatforms();
            loadCurrentConfigs();
            loadCookieStatus();

            // æ¯10ç§’è‡ªåŠ¨åˆ·æ–°é…ç½®çŠ¶æ€
            configRefreshTimer = setInterval(loadCurrentConfigs, 10000);
        });

        // æ—¥æœŸå˜åŒ–æ—¶é‡æ–°åŠ è½½å…³é”®è¯æ ‡ç­¾
        function onKeywordDateChange() {
            loadAvailableKeywords();
        }

        // åˆ‡æ¢å…³é”®è¯å±•å¼€/æ”¶èµ·
        function toggleKeywords() {
            const container = document.getElementById('keywordTags');
            const icon = document.getElementById('toggleKeywordsIcon');
            const text = document.getElementById('toggleKeywordsText');

            if (container.classList.contains('collapsed')) {
                container.classList.remove('collapsed');
                icon.textContent = 'â–²';
                text.textContent = 'æ”¶èµ·';
            } else {
                container.classList.add('collapsed');
                icon.textContent = 'â–¼';
                text.textContent = 'å±•å¼€æ›´å¤š';
            }
        }

        // åŠ è½½å¯ç”¨å…³é”®è¯ï¼ˆæŒ‰æ—¥æœŸè¿‡æ»¤ï¼‰
        async function loadAvailableKeywords() {
            try {
                const date = document.getElementById('keywordDateInput').value;
                let url = '/monitoring/api/crawler/keywords';
                if (date) url += '?date=' + encodeURIComponent(date);

                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    // æ ‡ç­¾åªå±•ç¤ºæ¯æ—¥æ–°é—»åˆ†æå…³é”®è¯
                    availableKeywords = result.data.daily || [];
                    const label = document.getElementById('kwCountLabel');
                    label.textContent = availableKeywords.length > 0
                        ? `å…± ${availableKeywords.length} ä¸ªå…³é”®è¯`
                        : 'è¯¥æ—¥æœŸæš‚æ— å…³é”®è¯æ•°æ®';
                    renderKeywordTags();
                }
            } catch (error) {
                console.error('åŠ è½½å…³é”®è¯å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“å…³é”®è¯æ ‡ç­¾
        function renderKeywordTags() {
            const container = document.getElementById('keywordTags');
            const input = document.getElementById('manualKeywords');
            const toggleBtn = document.getElementById('toggleKeywordsBtn');
            container.innerHTML = '';

            availableKeywords.forEach((keyword, index) => {
                const tag = document.createElement('div');
                tag.className = 'keyword-tag';

                // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªå¹¶æ·»åŠ åˆ°è¾“å…¥æ¡†
                if (index === 0 && !input.value.trim()) {
                    tag.classList.add('selected');
                    input.value = keyword;
                }

                tag.textContent = keyword;
                tag.onclick = () => toggleKeyword(keyword, tag);
                container.appendChild(tag);
            });

            // æ£€æµ‹æ˜¯å¦éœ€è¦æ˜¾ç¤ºå±•å¼€/æ”¶èµ·æŒ‰é’®
            setTimeout(() => {
                const actualHeight = container.scrollHeight;
                if (actualHeight > 140) {
                    toggleBtn.style.display = 'flex';
                    container.classList.add('collapsed');
                } else {
                    toggleBtn.style.display = 'none';
                    container.classList.remove('collapsed');
                }
            }, 0);
        }

        // åˆ‡æ¢å…³é”®è¯é€‰æ‹©ï¼ˆç›´æ¥æ“ä½œè¾“å…¥æ¡†ï¼‰
        function toggleKeyword(keyword, element) {
            const input = document.getElementById('manualKeywords');
            const currentKeywords = input.value.trim() ? input.value.split(/[,ï¼Œ\s]+/).filter(k => k.trim()) : [];
            const index = currentKeywords.indexOf(keyword);

            if (index > -1) {
                // å–æ¶ˆé€‰ä¸­ï¼šä»è¾“å…¥æ¡†ä¸­ç§»é™¤
                currentKeywords.splice(index, 1);
                element.classList.remove('selected');
            } else {
                // é€‰ä¸­ï¼šæ·»åŠ åˆ°è¾“å…¥æ¡†
                if (currentKeywords.length >= 10) {
                    showMessage('æœ€å¤šåªèƒ½é€‰æ‹©10ä¸ªå…³é”®è¯', 'error');
                    return;
                }
                currentKeywords.push(keyword);
                element.classList.add('selected');
            }

            // æ›´æ–°è¾“å…¥æ¡†çš„å€¼
            input.value = currentKeywords.join(', ');
        }

        // åŠ è½½å¯ç”¨å¹³å°
        async function loadAvailablePlatforms() {
            try {
                const response = await fetch('/monitoring/api/crawler/platforms');
                const result = await response.json();

                if (result.success) {
                    availablePlatforms = result.data;
                    renderPlatforms();
                }
            } catch (error) {
                console.error('åŠ è½½å¹³å°å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“å¹³å°
        function renderPlatforms() {
            const container = document.getElementById('platformsGrid');
            container.innerHTML = '';

            availablePlatforms.forEach((platform, index) => {
                const item = document.createElement('div');
                item.className = 'platform-item';

                // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªå¹³å°
                if (index === 0 && selectedPlatforms.length === 0) {
                    item.classList.add('selected');
                    selectedPlatforms.push(platform.code);
                }

                item.innerHTML = `
                    <div class="platform-icon">${platform.icon}</div>
                    <div class="platform-name">${platform.name}</div>
                `;
                item.onclick = () => togglePlatform(platform.code, item);
                container.appendChild(item);
            });
        }

        // åˆ‡æ¢å¹³å°é€‰æ‹©
        function togglePlatform(code, element) {
            const index = selectedPlatforms.indexOf(code);

            if (index > -1) {
                selectedPlatforms.splice(index, 1);
                element.classList.remove('selected');
            } else {
                selectedPlatforms.push(code);
                element.classList.add('selected');
            }
        }

        // ä¿å­˜é…ç½®
        async function saveConfig() {
            // åªä»è¾“å…¥æ¡†è·å–å…³é”®è¯
            const input = document.getElementById('manualKeywords').value.trim();

            if (!input) {
                showMessage('è¯·è‡³å°‘é€‰æ‹©æˆ–è¾“å…¥ä¸€ä¸ªå…³é”®è¯', 'error');
                return;
            }

            // è§£æå…³é”®è¯
            const finalKeywords = input.split(/[,ï¼Œ\s]+/).filter(k => k.trim());

            // éªŒè¯
            if (finalKeywords.length === 0) {
                showMessage('è¯·è‡³å°‘é€‰æ‹©æˆ–è¾“å…¥ä¸€ä¸ªå…³é”®è¯', 'error');
                return;
            }

            if (finalKeywords.length > 10) {
                showMessage('å…³é”®è¯æœ€å¤š10ä¸ª', 'error');
                return;
            }

            if (selectedPlatforms.length === 0) {
                showMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå¹³å°', 'error');
                return;
            }

            const interval = document.getElementById('intervalSelect').value;

            // æäº¤é…ç½®
            try {
                const response = await fetch('/monitoring/api/crawler/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keywords: finalKeywords,
                        platforms: selectedPlatforms,
                        interval: interval
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('çˆ¬è™«ä»»åŠ¡å·²å¯åŠ¨', 'success');
                    loadCurrentConfigs();
                } else {
                    showMessage(result.message || 'ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯ï¼š' + error.message, 'error');
            }
        }

        // åŠ è½½å½“å‰é…ç½®
        async function loadCurrentConfigs() {
            try {
                const response = await fetch('/monitoring/api/crawler/configs');
                const result = await response.json();

                if (result.success) {
                    renderConfigList(result.data);
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                document.getElementById('configList').innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
            }
        }

        // è®¡ç®—ä»»åŠ¡çš„èšåˆçŠ¶æ€
        function getTaskStatus(task, runningDetails) {
            const config = task.config;
            const subTasks = [];
            for (const kw of config.keywords) {
                for (const p of config.platforms) {
                    const key = `${kw}_${p}`;
                    if (runningDetails[key]) {
                        subTasks.push(runningDetails[key]);
                    }
                }
            }

            if (subTasks.length === 0) {
                return { label: 'ç­‰å¾…ä¸­', css: 'status-pending' };
            }

            const hasRunning = subTasks.some(t => t.status === 'running');
            const hasFailed = subTasks.some(t => t.status === 'failed' || t.status === 'error');
            const allCompleted = subTasks.every(t => t.status === 'completed');

            if (hasRunning) return { label: 'è¿è¡Œä¸­', css: 'status-running' };
            if (allCompleted) return { label: 'å·²å®Œæˆ', css: 'status-completed' };
            if (hasFailed && subTasks.some(t => t.status === 'completed')) return { label: 'éƒ¨åˆ†å¤±è´¥', css: 'status-failed' };
            if (hasFailed) return { label: 'å¤±è´¥', css: 'status-failed' };
            return { label: 'ç­‰å¾…ä¸­', css: 'status-pending' };
        }

        // æ¸²æŸ“é…ç½®åˆ—è¡¨
        function renderConfigList(data) {
            const container = document.getElementById('configList');
            const configs = data.configs || [];
            const runningDetails = data.running_details || {};

            document.getElementById('jobCount').textContent = `${configs.length} ä¸ªä»»åŠ¡`;

            if (configs.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— é…ç½®</div>';
                return;
            }

            container.innerHTML = '';

            configs.forEach(task => {
                const config = task.config;
                const enabled = task.enable !== false;
                const item = document.createElement('div');
                item.className = 'config-item' + (enabled ? '' : ' paused');

                const platformNames = config.platforms.map(p => {
                    const platform = availablePlatforms.find(ap => ap.code === p);
                    return platform ? platform.name : p;
                }).join('ã€');

                const status = enabled ? getTaskStatus(task, runningDetails) : { label: 'å·²æš‚åœ', css: 'status-paused' };
                const isRunning = status.label === 'è¿è¡Œä¸­';

                item.innerHTML = `
                    <div class="config-item-header">
                        <div class="config-item-title">
                            ğŸ“‹ ä»»åŠ¡ID: ${task.id}
                            <span class="status-badge ${status.css}">${status.label}</span>
                        </div>
                        <div class="item-actions">
                            <button class="pause-btn ${enabled ? '' : 'resume'}"
                                onclick="toggleEnable('${task.id}', ${enabled})"
                                ${isRunning ? 'disabled title="ä»»åŠ¡è¿è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆåå†æš‚åœ"' : ''}>
                                ${enabled ? 'æš‚åœ' : 'æ¢å¤'}
                            </button>
                            <button class="delete-btn" onclick="deleteConfig('${task.id}')">åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="config-item-details">
                        <div><strong>å…³é”®è¯:</strong> ${config.keywords.join('ã€')}</div>
                        <div><strong>å¹³å°:</strong> ${platformNames}</div>
                        <div><strong>æ‰§è¡Œé¢‘ç‡:</strong> ${config.interval === '5min' ? 'æ¯5åˆ†é’Ÿ' : config.interval === '10min' ? 'æ¯10åˆ†é’Ÿ' : config.interval === '30min' ? 'æ¯30åˆ†é’Ÿ' : 'æ¯å°æ—¶'}</div>
                        <div><strong>åˆ›å»ºæ—¶é—´:</strong> ${task.created_at}</div>
                    </div>
                `;

                container.appendChild(item);
            });
        }

        // æš‚åœ/æ¢å¤ä»»åŠ¡
        async function toggleEnable(taskId, currentEnable) {
            try {
                const response = await fetch(`/monitoring/api/crawler/config/${taskId}`, {
                    method: 'PATCH'
                });
                const result = await response.json();
                if (result.success) {
                    showMessage(result.enable ? 'ä»»åŠ¡å·²æ¢å¤' : 'ä»»åŠ¡å·²æš‚åœ', 'success');
                    loadCurrentConfigs();
                } else {
                    showMessage(result.message || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯ï¼š' + error.message, 'error');
            }
        }

        // åˆ é™¤é…ç½®
        async function deleteConfig(taskId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé…ç½®å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/monitoring/api/crawler/config/${taskId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('åˆ é™¤æˆåŠŸ', 'success');
                    loadCurrentConfigs();
                } else {
                    showMessage(result.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯ï¼š' + error.message, 'error');
            }
        }

        // åŠ è½½Cookieé…ç½®çŠ¶æ€
        async function loadCookieStatus() {
            try {
                const response = await fetch('/monitoring/api/crawler/cookies');
                const result = await response.json();
                if (result.success) {
                    cookieStatus = result.data;
                    renderCookieTabs();
                }
            } catch (error) {
                console.error('åŠ è½½CookieçŠ¶æ€å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“Cookieå¹³å°æ ‡ç­¾
        function renderCookieTabs() {
            const container = document.getElementById('cookiePlatformTabs');
            const platformMap = {
                'xhs': 'å°çº¢ä¹¦', 'dy': 'æŠ–éŸ³', 'bili': 'Bç«™',
                'wb': 'å¾®åš', 'tieba': 'è´´å§', 'zhihu': 'çŸ¥ä¹', 'ks': 'å¿«æ‰‹'
            };
            container.innerHTML = '';

            for (const [code, name] of Object.entries(platformMap)) {
                const tab = document.createElement('div');
                const status = cookieStatus[code];
                const isConfigured = status && status.configured;
                tab.className = 'cookie-tab' + (code === activeCookiePlatform ? ' active' : '');
                tab.innerHTML = `${name}<span class="cookie-status ${isConfigured ? 'configured' : 'empty'}"></span>`;
                tab.onclick = () => selectCookiePlatform(code);
                container.appendChild(tab);
            }

            // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
            if (!activeCookiePlatform) {
                selectCookiePlatform('xhs');
            }
        }

        // é€‰æ‹©Cookieå¹³å°
        function selectCookiePlatform(code) {
            activeCookiePlatform = code;
            document.getElementById('cookieInput').value = '';
            document.getElementById('cookieSaveStatus').textContent = '';

            // æ›´æ–°tabæ ·å¼
            document.querySelectorAll('.cookie-tab').forEach((tab, i) => {
                const platforms = ['xhs', 'dy', 'bili', 'wb', 'tieba', 'zhihu', 'ks'];
                tab.classList.toggle('active', platforms[i] === code);
            });

            const status = cookieStatus[code];
            if (status && status.configured) {
                document.getElementById('cookieInput').placeholder = `å·²é…ç½® (${status.length} å­—ç¬¦)ï¼Œç²˜è´´æ–°å€¼å¯è¦†ç›–`;
            } else {
                document.getElementById('cookieInput').placeholder = 'ä»æµè§ˆå™¨å¼€å‘è€…å·¥å…·(F12)ä¸­å¤åˆ¶Cookieå­—ç¬¦ä¸²ç²˜è´´åˆ°æ­¤å¤„\næ ¼å¼: name1=value1; name2=value2; ...';
            }
        }

        // ä¿å­˜Cookie
        async function saveCookie() {
            if (!activeCookiePlatform) {
                showMessage('è¯·å…ˆé€‰æ‹©å¹³å°', 'error');
                return;
            }
            const cookieValue = document.getElementById('cookieInput').value.trim();
            if (!cookieValue) {
                showMessage('è¯·ç²˜è´´Cookieå­—ç¬¦ä¸²', 'error');
                return;
            }

            const statusEl = document.getElementById('cookieSaveStatus');
            statusEl.textContent = 'ä¿å­˜ä¸­...';

            try {
                const response = await fetch('/monitoring/api/crawler/cookies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        platform: activeCookiePlatform,
                        cookies: cookieValue
                    })
                });
                const result = await response.json();
                if (result.success) {
                    statusEl.textContent = 'å·²ä¿å­˜';
                    statusEl.style.color = '#48bb78';
                    loadCookieStatus();
                } else {
                    statusEl.textContent = 'ä¿å­˜å¤±è´¥: ' + result.message;
                    statusEl.style.color = '#e53e3e';
                }
            } catch (error) {
                statusEl.textContent = 'ç½‘ç»œé”™è¯¯';
                statusEl.style.color = '#e53e3e';
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.className = `message message-${type}`;
            messageEl.textContent = text;
            messageEl.style.display = 'block';

            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
