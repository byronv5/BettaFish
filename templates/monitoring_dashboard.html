<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èˆ†æƒ…ç›‘æ§ä»ªè¡¨æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", Arial, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            padding: 16px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: #fff;
            border-radius: 4px;
            padding: 20px 24px;
            margin-bottom: 16px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
            border: 1px solid #e8ecf0;
        }

        .header h1 {
            color: #303133;
            font-size: 20px;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .header .subtitle {
            color: #909399;
            font-size: 13px;
        }

        .topic-card {
            background: #fff;
            border-radius: 4px;
            padding: 20px 24px;
            margin-bottom: 16px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
            border: 1px solid #e8ecf0;
        }

        .topic-card h2 {
            color: #303133;
            font-size: 16px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .topic-card .topic-name {
            color: #2d5f8a;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .topic-card .topic-desc {
            color: #606266;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .topic-card .keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .keyword-tag {
            background: #e8f0f7;
            color: #2d5f8a;
            padding: 4px 12px;
            border-radius: 3px;
            font-size: 13px;
            font-weight: 500;
        }

        .topic-card .meta {
            color: #909399;
            font-size: 12px;
            margin-top: 12px;
        }

        .topic-refresh-btn {
            padding: 2px 10px;
            font-size: 12px;
            background: #f0f4f8;
            color: #606266;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            cursor: pointer;
            vertical-align: middle;
            margin-left: 8px;
        }

        .topic-refresh-btn:hover:not(:disabled) {
            background: #e6ecf5;
            color: #2d5f8a;
            border-color: #b3c6d9;
        }

        .topic-refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .topic-refresh-msg {
            font-size: 12px;
            color: #909399;
            margin-left: 6px;
            vertical-align: middle;
        }

        .topic-refresh-msg.success { color: #67c23a; }
        .topic-refresh-msg.error   { color: #f56c6c; }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .chart-card {
            background: #fff;
            border-radius: 4px;
            padding: 20px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
            border: 1px solid #e8ecf0;
        }

        .chart-card h3 {
            color: #303133;
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e8ecf0;
        }

        .chart-container {
            width: 100%;
            height: 350px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 350px;
            color: #909399;
            font-size: 14px;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .error-message {
            background: #fff2f0;
            color: #cf1322;
            padding: 12px 16px;
            border-radius: 4px;
            border: 1px solid #ffccc7;
            margin: 16px 0;
            font-size: 13px;
        }

        .refresh-btn, .config-btn {
            background: #2d5f8a;
            color: #fff;
            border: none;
            padding: 8px 18px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
            margin-right: 8px;
        }

        .config-btn {
            background: #fff;
            color: #606266;
            border: 1px solid #d9dfe6;
        }

        .refresh-btn:hover {
            background: #1d4a6e;
        }

        .config-btn:hover {
            border-color: #2d5f8a;
            color: #2d5f8a;
        }

        .refresh-btn:active, .config-btn:active {
            transform: none;
        }

        .keyword-filter {
            display: inline-flex;
            align-items: center;
            margin-left: 16px;
            vertical-align: middle;
        }

        .keyword-filter label {
            color: #606266;
            font-size: 13px;
            margin-right: 8px;
            white-space: nowrap;
        }

        .keyword-filter select {
            padding: 7px 12px;
            border: 1px solid #d9dfe6;
            border-radius: 4px;
            font-size: 13px;
            color: #303133;
            background: #fff;
            cursor: pointer;
            outline: none;
            transition: border-color 0.2s;
            min-width: 140px;
        }

        .keyword-filter select:focus {
            border-color: #2d5f8a;
        }

        .date-filter {
            display: inline-flex;
            align-items: center;
            margin-left: 16px;
            vertical-align: middle;
        }

        .date-filter label {
            color: #606266;
            font-size: 13px;
            margin-right: 8px;
            white-space: nowrap;
        }

        .date-filter input[type="date"] {
            padding: 7px 12px;
            border: 1px solid #d9dfe6;
            border-radius: 4px;
            font-size: 13px;
            color: #303133;
            background: #fff;
            outline: none;
            transition: border-color 0.2s;
            cursor: pointer;
        }

        .date-filter input[type="date"]:focus {
            border-color: #2d5f8a;
        }

        @media (max-width: 1024px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ========== æŠ¥å‘Šæ¨¡å— ========== */
        .report-card {
            background: #fff;
            border-radius: 4px;
            padding: 20px 24px;
            margin-bottom: 16px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
            border: 1px solid #e8ecf0;
        }

        .report-card h2 {
            color: #303133;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e8ecf0;
        }

        .report-generate-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 18px;
            flex-wrap: wrap;
        }

        .report-generate-row label {
            color: #606266;
            font-size: 13px;
            white-space: nowrap;
        }

        .report-keyword-input {
            flex: 1;
            min-width: 160px;
            max-width: 300px;
            padding: 7px 12px;
            border: 1px solid #d9dfe6;
            border-radius: 4px;
            font-size: 13px;
            color: #303133;
            outline: none;
            transition: border-color 0.2s;
        }

        .report-keyword-input:focus {
            border-color: #2d5f8a;
        }

        .report-generate-btn {
            background: #2d5f8a;
            color: #fff;
            border: none;
            padding: 8px 18px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .report-generate-btn:hover {
            background: #1d4a6e;
        }

        .report-generate-btn:disabled {
            background: #a0b4c8;
            cursor: not-allowed;
        }

        .report-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .report-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            border: 1px solid #e8ecf0;
            border-radius: 4px;
            background: #fafbfc;
            font-size: 13px;
        }

        .report-item.running {
            border-color: #91caff;
            background: #e6f4ff;
        }

        .report-item.failed {
            border-color: #ffa39e;
            background: #fff2f0;
        }

        .report-item-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .report-item-info {
            flex: 1;
            min-width: 0;
        }

        .report-item-name {
            color: #303133;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .report-item-meta {
            color: #909399;
            font-size: 12px;
            margin-top: 2px;
        }

        .report-progress-wrap {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 6px;
        }

        .report-progress-bar {
            flex: 1;
            height: 6px;
            background: #dce6ef;
            border-radius: 3px;
            overflow: hidden;
        }

        .report-progress-inner {
            height: 100%;
            background: #2d5f8a;
            border-radius: 3px;
            transition: width 0.4s ease;
        }

        .report-progress-pct {
            color: #2d5f8a;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        .report-download-btn {
            background: #fff;
            color: #2d5f8a;
            border: 1px solid #2d5f8a;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            text-decoration: none;
            white-space: nowrap;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .report-download-btn:hover {
            background: #2d5f8a;
            color: #fff;
        }

        .report-delete-btn {
            background: #fff;
            color: #cf1322;
            border: 1px solid #cf1322;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .report-delete-btn:hover {
            background: #cf1322;
            color: #fff;
        }

        .report-empty {
            color: #909399;
            font-size: 13px;
            text-align: center;
            padding: 24px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æœ€æ–°è¯é¢˜å±•ç¤º -->
        <div class="topic-card" id="topicCard">
            <div class="loading">åŠ è½½ä¸­</div>
        </div>

	<div class="header">
            <h1>ğŸŸ èˆ†æƒ…ç›‘æ§ä»ªè¡¨æ¿</h1>
            <p class="subtitle">å®æ—¶è¿½è¸ªçƒ­ç‚¹è¯é¢˜ï¼Œæ´å¯Ÿèˆ†æƒ…åŠ¨æ€</p>
            <button class="refresh-btn" onclick="loadAllData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            <button class="config-btn" onclick="window.location.href='/monitoring/crawler-config'">âš™ï¸ çˆ¬è™«é…ç½®</button>
            <div class="date-filter">
                <label for="dateSelect">æ—¥æœŸ:</label>
                <input type="date" id="dateSelect" onchange="loadAllData()" />
            </div>
            <div class="keyword-filter">
                <label for="keywordSelect">å…³é”®è¯ç­›é€‰:</label>
                <select id="keywordSelect" onchange="loadAllData(true)">
                </select>
            </div>
        </div>

        <!-- å››ä¸ªæŒ‡æ ‡å›¾è¡¨ -->
        <div class="charts-grid">
            <!-- 1. èˆ†æƒ…çƒ­åº¦è¶‹åŠ¿ -->
            <div class="chart-card">
                <h3>ğŸ“ˆ èˆ†æƒ…çƒ­åº¦è¶‹åŠ¿</h3>
                <div id="trendChart" class="chart-container"></div>
            </div>

            <!-- 2. æƒ…æ„Ÿå€¾å‘æ¯”ä¾‹ -->
            <div class="chart-card">
                <h3>ğŸ˜Š æƒ…æ„Ÿå€¾å‘åˆ†å¸ƒ</h3>
                <div id="sentimentChart" class="chart-container"></div>
            </div>

            <!-- 3. ä¼ æ’­èŒƒå›´åˆ†æ -->
            <div class="chart-card">
                <h3>ğŸ—ºï¸ ä¼ æ’­èŒƒå›´åˆ†æ</h3>
                <div id="locationChart" class="chart-container"></div>
            </div>

            <!-- 4. ä¼ æ’­é€Ÿåº¦åˆ†æ -->
            <div class="chart-card">
                <h3>âš¡ ä¼ æ’­é€Ÿåº¦åˆ†æ</h3>
                <div id="speedChart" class="chart-container"></div>
            </div>
        </div>

        <!-- æŠ¥å‘Šåˆ—è¡¨æ¨¡å— -->
        <div class="report-card">
            <h2>ğŸ“„ æ·±åº¦åˆ†ææŠ¥å‘Š</h2>

            <!-- ç”ŸæˆæŠ¥å‘Šè¡Œ -->
            <div class="report-generate-row">
                <label for="reportKeywordInput">å…³é”®è¯:</label>
                <input
                    id="reportKeywordInput"
                    class="report-keyword-input"
                    type="text"
                    placeholder="è¯·è¾“å…¥åˆ†æå…³é”®è¯"
                />
                <button id="reportGenerateBtn" class="report-generate-btn" onclick="startReportGeneration()" disabled>
                    â–¶ å¼€å§‹ç”ŸæˆæŠ¥å‘Š
                </button>
            </div>
            <div id="reportSystemHint" style="color:#909399;font-size:12px;margin-bottom:10px;">
                â³ æ­£åœ¨æ£€æµ‹ç³»ç»ŸçŠ¶æ€ï¼Œè¯·ç¨å€™...
            </div>

            <!-- æŠ¥å‘Šåˆ—è¡¨ -->
            <div id="reportList" class="report-list">
                <div class="report-empty">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–å›¾è¡¨å®ä¾‹
        let trendChart = echarts.init(document.getElementById('trendChart'));
        let sentimentChart = echarts.init(document.getElementById('sentimentChart'));
        let locationChart = echarts.init(document.getElementById('locationChart'));
        let speedChart = echarts.init(document.getElementById('speedChart'));

        // æ˜¾ç¤ºåŠ è½½ä¸­
        function showLoading() {
            trendChart.showLoading();
            sentimentChart.showLoading();
            locationChart.showLoading();
            speedChart.showLoading();
        }

        // éšè—åŠ è½½ä¸­
        function hideLoading() {
            trendChart.hideLoading();
            sentimentChart.hideLoading();
            locationChart.hideLoading();
            speedChart.hideLoading();
        }

        // æ¸²æŸ“è¯é¢˜ä¿¡æ¯
        function renderTopicInfo(topic) {
            const topicCard = document.getElementById('topicCard');

            const keywords = topic.keywords || [];
            const keywordsHtml = keywords.length > 0
                ? keywords.map(kw => `<span class="keyword-tag">${kw}</span>`).join('')
                : '<span class="keyword-tag">æš‚æ— å…³é”®è¯</span>';

            topicCard.innerHTML = `
                <div class="topic-name">${topic.topic_name || 'æš‚æ— è¯é¢˜'}</div>
                <div class="topic-desc">${topic.topic_description || 'æš‚æ— æè¿°'}</div>
                <div class="keywords">${keywordsHtml}</div>
                <div class="meta">
                    æå–æ—¥æœŸ: ${topic.extract_date || 'æœªçŸ¥'} | è¯é¢˜ID: ${topic.topic_id || 'N/A'}
                    <button class="topic-refresh-btn" id="dailyNewsRefreshBtn" onclick="triggerDailyNewsRefresh()">ğŸ”„ é‡æ–°æå–</button>
                    <span class="topic-refresh-msg" id="dailyNewsRefreshMsg"></span>
                </div>
            `;
        }

        // æ¸²æŸ“èˆ†æƒ…çƒ­åº¦è¶‹åŠ¿å›¾
        function renderTrendChart(data) {
            const option = {
                title: {
                    text: 'æœ€è¿‘6å¤©è¯„è®ºæ•°è¶‹åŠ¿',
                    textStyle: { fontSize: 14, color: '#718096' },
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                xAxis: {
                    type: 'category',
                    data: data.dates || [],
                    axisLabel: {
                        rotate: 45,
                        fontSize: 12
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'è¯„è®ºæ•°',
                    axisLabel: { fontSize: 12 }
                },
                series: [{
                    name: 'è¯„è®ºæ•°',
                    type: 'line',
                    data: data.comment_counts || [],
                    smooth: true,
                    itemStyle: {
                        color: '#2d5f8a'
                    },
                    areaStyle: {
                        color: {
                            type: 'linear',
                            x: 0, y: 0, x2: 0, y2: 1,
                            colorStops: [
                                { offset: 0, color: 'rgba(45, 95, 138, 0.25)' },
                                { offset: 1, color: 'rgba(45, 95, 138, 0.03)' }
                            ]
                        }
                    }
                }],
                grid: {
                    left: '10%',
                    right: '5%',
                    bottom: '15%',
                    top: '15%'
                }
            };

            trendChart.setOption(option);
        }

        // æ¸²æŸ“æƒ…æ„Ÿåˆ†å¸ƒé¥¼å›¾
        function renderSentimentChart(data) {
            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c} ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    top: 'center'
                },
                series: [{
                    name: 'æƒ…æ„Ÿåˆ†å¸ƒ',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    avoidLabelOverlap: true,
                    itemStyle: {
                        borderRadius: 10,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        formatter: '{b}\n{d}%'
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: 16,
                            fontWeight: 'bold'
                        }
                    },
                    data: [
                        {
                            value: data.positive || 0,
                            name: 'æ­£å‘',
                            itemStyle: { color: '#48bb78' }
                        },
                        {
                            value: data.neutral || 0,
                            name: 'ä¸­æ€§',
                            itemStyle: { color: '#ecc94b' }
                        },
                        {
                            value: data.negative || 0,
                            name: 'è´Ÿé¢',
                            itemStyle: { color: '#f56565' }
                        }
                    ]
                }]
            };

            sentimentChart.setOption(option);

            // ç‚¹å‡»é¥¼å›¾æ‰‡åŒº â†’ æ–°æ ‡ç­¾é¡µæ‰“å¼€è¯„è®ºæ˜ç»†
            sentimentChart.off('click');
            sentimentChart.on('click', function(params) {
                const labelToSentiment = { 'æ­£å‘': 2, 'ä¸­æ€§': 1, 'è´Ÿé¢': 0 };
                const s = labelToSentiment[params.name];
                if (s === undefined) return;
                const kw = document.getElementById('keywordSelect')?.value || '';
                let url = `/monitoring/comments?sentiment=${s}`;
                if (kw) url += `&keyword=${encodeURIComponent(kw)}`;
                window.open(url, '_blank');
            });
        }

        // æ¸²æŸ“åœ°åŸŸåˆ†å¸ƒæŸ±çŠ¶å›¾
        function renderLocationChart(data) {
            const locations = Object.keys(data);
            const counts = Object.values(data);

            const option = {
                title: {
                    text: 'TOP10åœ°åŸŸåˆ†å¸ƒ',
                    textStyle: { fontSize: 14, color: '#718096' },
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                xAxis: {
                    type: 'category',
                    data: locations,
                    axisLabel: {
                        rotate: 45,
                        fontSize: 12
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'è¯„è®ºæ•°',
                    axisLabel: { fontSize: 12 }
                },
                series: [{
                    name: 'è¯„è®ºæ•°',
                    type: 'bar',
                    data: counts,
                    itemStyle: {
                        color: {
                            type: 'linear',
                            x: 0, y: 0, x2: 0, y2: 1,
                            colorStops: [
                                { offset: 0, color: '#2d5f8a' },
                                { offset: 1, color: '#5a9cbf' }
                            ]
                        },
                        borderRadius: [5, 5, 0, 0]
                    },
                    emphasis: {
                        itemStyle: {
                            color: '#1d4a6e'
                        }
                    }
                }],
                grid: {
                    left: '10%',
                    right: '5%',
                    bottom: '20%',
                    top: '15%'
                }
            };

            locationChart.setOption(option);
        }

        // æ¸²æŸ“ä¼ æ’­é€Ÿåº¦å›¾
        function renderSpeedChart(data) {
            const option = {
                title: {
                    text: '24å°æ—¶è¯„è®ºåˆ†å¸ƒ',
                    textStyle: { fontSize: 14, color: '#718096' },
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' }
                },
                xAxis: {
                    type: 'category',
                    data: data.hours || [],
                    axisLabel: {
                        rotate: 45,
                        fontSize: 10
                    },
                    boundaryGap: false
                },
                yAxis: {
                    type: 'value',
                    name: 'è¯„è®ºæ•°',
                    axisLabel: { fontSize: 12 }
                },
                series: [{
                    name: 'è¯„è®ºæ•°',
                    type: 'line',
                    data: data.comment_counts || [],
                    smooth: true,
                    itemStyle: {
                        color: '#f56565'
                    },
                    areaStyle: {
                        color: {
                            type: 'linear',
                            x: 0, y: 0, x2: 0, y2: 1,
                            colorStops: [
                                { offset: 0, color: 'rgba(245, 101, 101, 0.3)' },
                                { offset: 1, color: 'rgba(245, 101, 101, 0.05)' }
                            ]
                        }
                    }
                }],
                grid: {
                    left: '10%',
                    right: '5%',
                    bottom: '20%',
                    top: '15%'
                }
            };

            speedChart.setOption(option);
        }

        // è¿”å›ä»Šå¤©çš„ CST æ—¥æœŸå­—ç¬¦ä¸² YYYY-MM-DD
        function getTodayCST() {
            const now = new Date();
            const cst = new Date(now.getTime() + 8 * 60 * 60 * 1000);
            return cst.toISOString().slice(0, 10);
        }

        // åŠ è½½å…³é”®è¯åˆ—è¡¨ï¼ˆæŒ‰å½“å‰é€‰ä¸­æ—¥æœŸè¿‡æ»¤ï¼Œä¿ç•™å½“å‰é€‰ä¸­å…³é”®è¯ï¼‰
        async function loadKeywords() {
            try {
                const date = document.getElementById('dateSelect').value;
                let url = '/monitoring/api/crawler/keywords';
                if (date) url += '?date=' + encodeURIComponent(date);
                const response = await fetch(url);
                const result = await response.json();
                const select = document.getElementById('keywordSelect');
                const currentValue = select.value;

                // æ¸…ç©ºæ—§é€‰é¡¹ï¼ˆå« optgroupï¼‰
                select.innerHTML = '';

                if (result.success && result.data) {
                    const crawlerKws = result.data.crawler || [];
                    // ç›‘æ§ä¸‹æ‹‰ä¸­ daily ç»„å»æ‰å·²åœ¨ crawler ç»„çš„é‡å¤é¡¹
                    const crawlerSet = new Set(crawlerKws);
                    const dailyKws   = (result.data.daily || []).filter(kw => !crawlerSet.has(kw));
                    const allKws     = [...crawlerKws, ...dailyKws];

                    function appendOptGroup(label, keywords) {
                        if (keywords.length === 0) return;
                        const group = document.createElement('optgroup');
                        group.label = label;
                        keywords.forEach(kw => {
                            const opt = document.createElement('option');
                            opt.value = kw;
                            opt.textContent = kw;
                            group.appendChild(opt);
                        });
                        select.appendChild(group);
                    }

                    appendOptGroup('çˆ¬è™«é…ç½®å…³é”®è¯', crawlerKws);
                    appendOptGroup('æ¯æ—¥æ–°é—»åˆ†æ', dailyKws);

                    // æ¢å¤ä¹‹å‰çš„é€‰ä¸­å€¼ï¼ˆè‹¥ä»åœ¨åˆ—è¡¨ä¸­ï¼‰
                    if (currentValue && allKws.includes(currentValue)) {
                        select.value = currentValue;
                    } else if (crawlerKws.length > 0) {
                        // é»˜è®¤é€‰ä¸­çˆ¬è™«é…ç½®ç¬¬ä¸€ä¸ªå…³é”®è¯
                        select.value = crawlerKws[0];
                    }

                    // å°†é€‰ä¸­å…³é”®è¯åŒæ­¥åˆ°æŠ¥å‘Šè¾“å…¥æ¡†ä½œä¸ºé»˜è®¤å€¼
                    const reportInput = document.getElementById('reportKeywordInput');
                    if (!reportInput.value && allKws.length > 0) {
                        reportInput.value = select.value || allKws[0];
                    }
                }
            } catch (error) {
                console.error('åŠ è½½å…³é”®è¯åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // ===== æ‰‹åŠ¨è§¦å‘æ¯æ—¥æ–°é—»æå– =====
        let _dailyNewsRefreshTimer = null;

        async function triggerDailyNewsRefresh() {
            const btn = document.getElementById('dailyNewsRefreshBtn');
            const msg = document.getElementById('dailyNewsRefreshMsg');
            if (!btn) return;

            btn.disabled = true;
            btn.textContent = 'â³ æå–ä¸­...';
            if (msg) { msg.className = 'topic-refresh-msg'; msg.textContent = 'æ­£åœ¨æŠ“å–ä»Šæ—¥æ–°é—»ï¼Œè¯·ç¨å€™...'; }

            try {
                const res = await fetch('/api/daily-news/refresh', { method: 'POST' });
                const result = await res.json();
                if (!result.success) {
                    if (btn) { btn.disabled = false; btn.textContent = 'ğŸ”„ é‡æ–°æå–'; }
                    if (msg) { msg.className = 'topic-refresh-msg error'; msg.textContent = result.message; }
                    return;
                }
            } catch (e) {
                if (btn) { btn.disabled = false; btn.textContent = 'ğŸ”„ é‡æ–°æå–'; }
                if (msg) { msg.className = 'topic-refresh-msg error'; msg.textContent = 'è¯·æ±‚å¤±è´¥: ' + e.message; }
                return;
            }

            // è½®è¯¢çŠ¶æ€
            if (_dailyNewsRefreshTimer) clearInterval(_dailyNewsRefreshTimer);
            _dailyNewsRefreshTimer = setInterval(async () => {
                try {
                    const res = await fetch('/api/daily-news/refresh/status');
                    const result = await res.json();
                    const btn2 = document.getElementById('dailyNewsRefreshBtn');
                    const msg2 = document.getElementById('dailyNewsRefreshMsg');

                    if (result.status === 'completed') {
                        clearInterval(_dailyNewsRefreshTimer);
                        _dailyNewsRefreshTimer = null;
                        if (msg2) { msg2.className = 'topic-refresh-msg success'; msg2.textContent = result.message; }
                        // é‡æ–°åŠ è½½å®Œæ•´æ•°æ®ï¼ˆå« topicCardï¼‰
                        await loadAllData(false);
                    } else if (result.status === 'failed') {
                        clearInterval(_dailyNewsRefreshTimer);
                        _dailyNewsRefreshTimer = null;
                        if (btn2) { btn2.disabled = false; btn2.textContent = 'ğŸ”„ é‡æ–°æå–'; }
                        if (msg2) { msg2.className = 'topic-refresh-msg error'; msg2.textContent = result.message; }
                    }
                    // running: ç»§ç»­è½®è¯¢
                } catch (e) {
                    clearInterval(_dailyNewsRefreshTimer);
                    _dailyNewsRefreshTimer = null;
                    const btn2 = document.getElementById('dailyNewsRefreshBtn');
                    if (btn2) { btn2.disabled = false; btn2.textContent = 'ğŸ”„ é‡æ–°æå–'; }
                }
            }, 2000);
        }

        // åŠ è½½æ‰€æœ‰æ•°æ®ï¼ˆå…ˆåˆ·æ–°å…³é”®è¯ä¸‹æ‹‰ï¼Œå†æ‹‰å›¾è¡¨æ•°æ®ï¼Œä¿è¯è”åŠ¨ï¼‰
        async function loadAllData(skipTopic = false) {
            showLoading();
            await loadKeywords();

            try {
                const keyword = document.getElementById('keywordSelect').value;
                const date = document.getElementById('dateSelect').value;
                let url = '/monitoring/api/all-data?days=6';
                if (keyword) url += '&keyword=' + encodeURIComponent(keyword);
                if (date)    url += '&date='    + encodeURIComponent(date);
                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    const { topic, trend, sentiment, location, speed } = result.data;

                    // æ¸²æŸ“è¯é¢˜ä¿¡æ¯ï¼ˆåˆ‡æ¢å…³é”®è¯æ—¶è·³è¿‡ï¼Œé¿å…è¦†ç›–æ¯æ—¥æ–°é—»åˆ†æï¼‰
                    if (!skipTopic) {
                        renderTopicInfo(topic);
                    }

                    // æ¸²æŸ“å›¾è¡¨
                    renderTrendChart(trend);
                    renderSentimentChart(sentiment);
                    renderLocationChart(location);
                    renderSpeedChart(speed);
                } else {
                    showError(result.message || 'æ•°æ®åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                hideLoading();
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const topicCard = document.getElementById('topicCard');
            topicCard.innerHTML = `
                <div class="error-message">
                    âŒ ${message}
                </div>
            `;
        }

        // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è°ƒæ•´å›¾è¡¨
        window.addEventListener('resize', () => {
            trendChart.resize();
            sentimentChart.resize();
            locationChart.resize();
            speedChart.resize();
        });

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åŠ è½½æ•°æ®
        document.addEventListener('DOMContentLoaded', () => {
            // åˆå§‹åŒ–æ—¥æœŸä¸ºä»Šå¤©ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
            document.getElementById('dateSelect').value = getTodayCST();
            // loadAllData å†…éƒ¨ä¼šå…ˆè°ƒç”¨ loadKeywordsï¼Œæ— éœ€å•ç‹¬è°ƒç”¨
            loadAllData();
            loadReports();
            initSystemStatus();  // è‡ªåŠ¨æ£€æµ‹å¹¶å¯åŠ¨ç³»ç»Ÿ
        });

        // ========== æŠ¥å‘Šæ¨¡å— ==========

        let _reportPollingTimer = null;   // æŠ¥å‘Šè¿›åº¦è½®è¯¢å®šæ—¶å™¨
        let _systemStatusTimer = null;    // ç³»ç»ŸçŠ¶æ€è½®è¯¢å®šæ—¶å™¨
        let _runningTaskIds = new Set();  // æ­£åœ¨è¿è¡Œçš„æŠ¥å‘Šä»»åŠ¡ID
        let _systemStarted = false;       // ç³»ç»Ÿæ˜¯å¦å·²å¯åŠ¨
        let _systemStarting = false;      // ç³»ç»Ÿæ˜¯å¦æ­£åœ¨å¯åŠ¨ä¸­

        // å½“å…³é”®è¯ç­›é€‰å˜åŒ–æ—¶ï¼ŒåŒæ­¥åˆ°æŠ¥å‘Šå…³é”®è¯è¾“å…¥æ¡†
        document.getElementById('keywordSelect').addEventListener('change', function() {
            const kw = this.value;
            if (kw) {
                document.getElementById('reportKeywordInput').value = kw;
            }
        });

        // ---- ç³»ç»ŸçŠ¶æ€ç®¡ç† ----

        /**
         * é¡µé¢æ‰“å¼€æ—¶è‡ªåŠ¨æ£€æµ‹ç³»ç»ŸçŠ¶æ€ï¼š
         *  - å·²å¯åŠ¨ â†’ ç›´æ¥è§£é”æŒ‰é’®
         *  - æ­£åœ¨å¯åŠ¨ï¼ˆæ¥è‡ªå…¶ä»–è¯·æ±‚ï¼‰â†’ è½®è¯¢ç›´åˆ°å®Œæˆ
         *  - æœªå¯åŠ¨ â†’ è‡ªåŠ¨è°ƒç”¨ /api/system/start å¯åŠ¨
         */
        async function initSystemStatus() {
            try {
                const res = await fetch('/api/system/status');
                const result = await res.json();

                if (result.started) {
                    _systemStarted = true;
                    _systemStarting = false;
                    updateGenerateButton();
                    return;
                }

                if (result.starting) {
                    // å…¶å®ƒè¯·æ±‚å·²åœ¨å¯åŠ¨ä¸­ï¼Œè½®è¯¢ç­‰å¾…
                    _systemStarted = false;
                    _systemStarting = true;
                    updateGenerateButton();
                    startSystemStatusPolling();
                    return;
                }

                // æœªå¯åŠ¨ä¹Ÿæœªåœ¨å¯åŠ¨ â†’ è‡ªåŠ¨è§¦å‘
                _systemStarted = false;
                _systemStarting = true;
                updateGenerateButton();
                triggerSystemStart();

            } catch (e) {
                console.error('æ£€æµ‹ç³»ç»ŸçŠ¶æ€å¤±è´¥:', e);
                _systemStarting = false;
                setSystemHint('âš  æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', '#cf1322');
                updateGenerateButton();
            }
        }

        /** è°ƒç”¨ /api/system/startï¼Œç­‰å¾…å“åº”åæ›´æ–°çŠ¶æ€ */
        async function triggerSystemStart() {
            try {
                const res = await fetch('/api/system/start', { method: 'POST' });
                const result = await res.json();

                if (result.success) {
                    _systemStarted = true;
                    _systemStarting = false;
                } else if (result.message === 'ç³»ç»Ÿå·²å¯åŠ¨') {
                    // å¹¶å‘ï¼šå¦ä¸€ä¸ªè¯·æ±‚å…ˆå®Œæˆäº†
                    _systemStarted = true;
                    _systemStarting = false;
                } else if (result.message === 'ç³»ç»Ÿæ­£åœ¨å¯åŠ¨') {
                    // å¹¶å‘ï¼šå¦ä¸€ä¸ªè¯·æ±‚æ­£åœ¨è¿›è¡Œï¼Œè½®è¯¢
                    startSystemStatusPolling();
                    return;
                } else {
                    // çœŸæ­£å¤±è´¥ï¼ˆé…ç½®ç¼ºå¤±ç­‰ï¼‰
                    _systemStarting = false;
                    setSystemHint(`âš  ç³»ç»Ÿå¯åŠ¨å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`, '#cf1322');
                }
            } catch (e) {
                _systemStarting = false;
                setSystemHint(`âš  å¯åŠ¨è¯·æ±‚å¤±è´¥: ${e.message}`, '#cf1322');
            }
            updateGenerateButton();
        }

        /** è½®è¯¢ /api/system/statusï¼Œç›´åˆ° started æˆ–ä¸å† starting */
        function startSystemStatusPolling() {
            if (_systemStatusTimer) return;
            _systemStatusTimer = setInterval(async () => {
                try {
                    const res = await fetch('/api/system/status');
                    const result = await res.json();
                    _systemStarted = result.started === true;
                    _systemStarting = result.starting === true;
                } catch (e) { /* ä¿æŒå½“å‰çŠ¶æ€ */ }

                updateGenerateButton();

                if (_systemStarted || !_systemStarting) {
                    clearInterval(_systemStatusTimer);
                    _systemStatusTimer = null;
                }
            }, 3000);
        }

        function setSystemHint(text, color) {
            const hint = document.getElementById('reportSystemHint');
            if (!hint) return;
            hint.textContent = text;
            hint.style.color = color || '#909399';
            hint.style.display = '';
        }

        function updateGenerateButton() {
            const btn = document.getElementById('reportGenerateBtn');
            const hint = document.getElementById('reportSystemHint');

            if (_runningTaskIds.size > 0) {
                btn.disabled = true;
                btn.textContent = 'â³ ç”Ÿæˆä¸­...';
                btn.title = '';
                if (hint) hint.style.display = 'none';
            } else if (_systemStarted) {
                btn.disabled = false;
                btn.textContent = 'â–¶ å¼€å§‹ç”ŸæˆæŠ¥å‘Š';
                btn.title = '';
                if (hint) hint.style.display = 'none';
            } else if (_systemStarting) {
                btn.disabled = true;
                btn.textContent = 'â³ ç³»ç»Ÿå¯åŠ¨ä¸­...';
                btn.title = '';
                // åªåœ¨ hint æ²¡æœ‰é”™è¯¯ä¿¡æ¯æ—¶æ‰æ˜¾ç¤ºå¯åŠ¨æç¤º
                if (hint && !hint.textContent.startsWith('âš ')) {
                    hint.textContent = 'æ­£åœ¨è‡ªåŠ¨å¯åŠ¨ Insight / Media / Query Engineï¼Œè¯·ç¨å€™...';
                    hint.style.color = '#909399';
                    hint.style.display = '';
                }
            } else {
                btn.disabled = true;
                btn.textContent = 'â–¶ å¼€å§‹ç”ŸæˆæŠ¥å‘Š';
                btn.title = 'ç³»ç»Ÿæœªå¯åŠ¨';
                // hint å·²ç”± setSystemHint è®¾ç½®é”™è¯¯ä¿¡æ¯ï¼Œä¸è¦†ç›–
            }
        }

        // åŠ è½½æŠ¥å‘Šåˆ—è¡¨
        async function loadReports() {
            try {
                const res = await fetch('/api/reports');
                const result = await res.json();
                if (!result.success) return;

                const { tasks, history } = result.data;

                // åˆå¹¶ï¼šä»»åŠ¡åœ¨å‰ï¼Œå†å²æ–‡ä»¶åœ¨åï¼ˆå†å²æ–‡ä»¶å·²ç»æŒ‰æ—¶é—´æ’åºï¼‰
                renderReportList(tasks, history);

                // å¦‚æœæœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œå¯åŠ¨è½®è¯¢
                const running = tasks.filter(t => t.status === 'running');
                if (running.length > 0) {
                    running.forEach(t => _runningTaskIds.add(t.task_id));
                    startReportPolling();
                }
                updateGenerateButton();
            } catch (e) {
                console.error('åŠ è½½æŠ¥å‘Šåˆ—è¡¨å¤±è´¥:', e);
            }
        }

        // æ¸²æŸ“æŠ¥å‘Šåˆ—è¡¨
        function renderReportList(tasks, history) {
            const container = document.getElementById('reportList');

            const items = [];

            // ä»»åŠ¡æ¡ç›®ï¼ˆè¿è¡Œä¸­ / å¤±è´¥ / å®Œæˆä½†å°šæœªè¿›å…¥historyï¼‰
            tasks.forEach(task => {
                items.push(buildTaskItem(task));
            });

            // å†å²æ–‡ä»¶ï¼ˆå·²å®Œæˆçš„ä»»åŠ¡å¯¹åº”çš„æ–‡ä»¶å·²ç»åŒ…å«åœ¨ history ä¸­ï¼‰
            // å»é‡ï¼šå¦‚æœ history ä¸­çš„æ–‡ä»¶åå·²ç»è¢«æŸä¸ªä»»åŠ¡è¦†ç›–ï¼Œåˆ™ä¸å†æ˜¾ç¤º
            const taskFilenames = new Set(tasks.filter(t => t.filename).map(t => t.filename));
            history.forEach(report => {
                if (!taskFilenames.has(report.filename)) {
                    items.push(buildHistoryItem(report));
                }
            });

            if (items.length === 0) {
                container.innerHTML = '<div class="report-empty">æš‚æ— æŠ¥å‘Šï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆé¦–ä»½æŠ¥å‘Š</div>';
                return;
            }

            container.innerHTML = items.join('');
        }

        function buildTaskItem(task) {
            const isRunning = task.status === 'running';
            const isFailed = task.status === 'failed';
            const isCompleted = task.status === 'completed';

            let icon = isRunning ? 'â³' : isFailed ? 'âŒ' : 'âœ…';
            let statusClass = isRunning ? 'running' : isFailed ? 'failed' : '';

            let progressHtml = '';
            if (isRunning) {
                progressHtml = `
                    <div class="report-progress-wrap">
                        <div class="report-progress-bar">
                            <div class="report-progress-inner" style="width:${task.progress}%"></div>
                        </div>
                        <span class="report-progress-pct">${task.progress}%</span>
                    </div>`;
            }

            let metaText = `å…³é”®è¯: ${escHtml(task.keyword)} &nbsp;|&nbsp; ${escHtml(task.created_at)}`;
            if (isFailed && task.error) {
                metaText += ` &nbsp;|&nbsp; <span style="color:#cf1322">é”™è¯¯: ${escHtml(task.error.slice(0,80))}</span>`;
            }

            let downloadBtn = '';
            if (isCompleted && task.filename) {
                downloadBtn = `
                    <a class="report-download-btn" href="/api/reports/download/${encodeURIComponent(task.filename)}" download>ä¸‹è½½</a>
                    <button class="report-delete-btn" onclick="deleteReport('${escHtml(task.filename)}')">åˆ é™¤</button>`;
            }

            let displayName = isCompleted && task.filename ? escHtml(task.filename) : `æ­£åœ¨ç”Ÿæˆ: ${escHtml(task.keyword)} çš„æŠ¥å‘Š`;

            return `
                <div class="report-item ${statusClass}" id="task-${task.task_id}">
                    <span class="report-item-icon">${icon}</span>
                    <div class="report-item-info">
                        <div class="report-item-name">${displayName}</div>
                        <div class="report-item-meta">${metaText}</div>
                        ${progressHtml}
                    </div>
                    ${downloadBtn}
                </div>`;
        }

        function buildHistoryItem(report) {
            return `
                <div class="report-item" id="hist-${escHtml(report.filename)}">
                    <span class="report-item-icon">ğŸ“‹</span>
                    <div class="report-item-info">
                        <div class="report-item-name">${escHtml(report.filename)}</div>
                        <div class="report-item-meta">${escHtml(report.created_at)}</div>
                    </div>
                    <a class="report-download-btn" href="/api/reports/download/${encodeURIComponent(report.filename)}" download>ä¸‹è½½</a>
                    <button class="report-delete-btn" onclick="deleteReport('${escHtml(report.filename)}')">åˆ é™¤</button>
                </div>`;
        }

        function escHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
        }

        // åˆ é™¤æŠ¥å‘Š
        async function deleteReport(filename) {
            if (!confirm(`ç¡®è®¤åˆ é™¤æŠ¥å‘Šæ–‡ä»¶ï¼š\n${filename}`)) return;
            try {
                const res = await fetch(`/api/reports/delete/${encodeURIComponent(filename)}`, { method: 'DELETE' });
                const result = await res.json();
                if (!result.success) {
                    alert('åˆ é™¤å¤±è´¥: ' + result.message);
                    return;
                }
                await loadReports();
            } catch (e) {
                alert('åˆ é™¤è¯·æ±‚å¤±è´¥: ' + e.message);
            }
        }

        // å¼€å§‹ç”ŸæˆæŠ¥å‘Š
        async function startReportGeneration() {
            const input = document.getElementById('reportKeywordInput');
            const keyword = input.value.trim();
            if (!keyword) {
                input.focus();
                return;
            }

            const btn = document.getElementById('reportGenerateBtn');
            btn.disabled = true;
            btn.textContent = 'æäº¤ä¸­...';

            try {
                const res = await fetch('/api/reports/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword })
                });
                const result = await res.json();
                if (!result.success) {
                    alert('å¯åŠ¨å¤±è´¥: ' + result.message);
                    return;
                }

                _runningTaskIds.add(result.task_id);
                startReportPolling();
                await loadReports();
            } catch (e) {
                alert('è¯·æ±‚å¤±è´¥: ' + e.message);
            } finally {
                updateGenerateButton();
            }
        }

        // è½®è¯¢è¿›åº¦
        function startReportPolling() {
            if (_reportPollingTimer) return; // å·²åœ¨è½®è¯¢
            _reportPollingTimer = setInterval(async () => {
                if (_runningTaskIds.size === 0) {
                    clearInterval(_reportPollingTimer);
                    _reportPollingTimer = null;
                    return;
                }

                const finished = [];
                for (const taskId of _runningTaskIds) {
                    try {
                        const res = await fetch(`/api/reports/progress/${taskId}`);
                        const result = await res.json();
                        if (!result.success) continue;
                        const task = result.data;

                        // æ›´æ–°è¿›åº¦æ¡ï¼ˆå¦‚æœæ¡ç›®å·²åœ¨DOMä¸­ï¼‰
                        updateTaskItemInDom(task);

                        if (task.status !== 'running') {
                            finished.push(taskId);
                        }
                    } catch (e) {
                        console.error('æŸ¥è¯¢è¿›åº¦å¤±è´¥:', e);
                    }
                }

                finished.forEach(id => _runningTaskIds.delete(id));
                if (finished.length > 0) {
                    updateGenerateButton();
                    await loadReports();
                }
            }, 2000);
        }

        // å°±åœ°æ›´æ–°ä»»åŠ¡DOMï¼ˆé¿å…æ•´ä¸ªåˆ—è¡¨é—ªçƒï¼‰
        function updateTaskItemInDom(task) {
            const el = document.getElementById(`task-${task.task_id}`);
            if (!el) return;
            // åªæ›´æ–°è¿›åº¦æ¡
            const bar = el.querySelector('.report-progress-inner');
            const pct = el.querySelector('.report-progress-pct');
            if (bar) bar.style.width = task.progress + '%';
            if (pct) pct.textContent = task.progress + '%';
        }
    </script>
</body>
</html>
